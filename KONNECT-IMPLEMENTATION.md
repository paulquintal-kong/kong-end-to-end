# Kong Konnect Terraform Implementation Summary

## What Was Created

### 1. Terraform Configuration Files

Created in `terraform/` directory:

#### `provider.tf`
- Configures Kong Konnect provider v0.9.0
- Points to AU region: https://au.api.konghq.com
- Uses PAT token from `var.konnect_pat`

#### `variables.tf`
- **konnect_pat** - Sensitive PAT token (from GitHub secrets)
- **fhir_server_url** - Ngrok URL (auto-generated by start_demo.sh)
- **Control Plane Variables**:
  - Name: "FHIR Patient Records Control Plane"
  - Description: "Dedicated control plane for FHIR patient records API"
- **Service Variables**:
  - Name: "Patient Records API"
  - Tags: ["FHIR", "Healthcare", "Patient Data"]
  - Version: "1.0.1"
- **Service Catalog Documentation**:
  - Purpose: FHIR R4 patient data management
  - Contact: Healthcare Team (healthcare-team@example.com)
  - Architecture: HAPI FHIR v8.6.0, H2 Database, OAuth2/API Key
  - Dependencies: HAPI FHIR, H2, Ngrok
  - Support SLA: 9-5 AEST, 4hr critical / 24hr standard

#### `terraform.tfvars`
- Auto-generated by `start_demo.sh`
- Contains current ngrok URL
- Regenerated each time you run `start_demo.sh`

#### `control_plane.tf`
- Creates control plane resource
- Labels: environment=development, team=healthcare, api_type=fhir
- Outputs: control_plane_id, control_plane_name, control_plane_endpoint

#### `service.tf`
- Creates two resources:
  1. **Main Service**: Patient Records API
  2. **Catalog Entry**: Same service with additional "catalog" and "documented" tags
- Configuration:
  - Protocol: HTTPS
  - Host: Extracted from ngrok URL
  - Port: 443
  - Path: /fhir
  - Retries: 5
  - Timeouts: 60s (connect/read/write)

#### `outputs.tf`
- Defines outputs for service ID, name, and URL

### 2. GitHub Actions Workflow

Created `.github/workflows/konnect-deploy.yml`:

#### Job 1: Deploy Service Catalog to Konnect
- Triggers on:
  - Push to `main` branch (when Terraform or OpenAPI files change)
  - Manual workflow dispatch
- Steps:
  1. Checkout code
  2. Setup Terraform 1.6.0
  3. Format check
  4. Initialize
  5. Validate
  6. Plan deployment
  7. Apply changes (auto-approved on `main` push)
  8. Generate deployment report with outputs

#### Job 2: Update Dev Portal (Placeholder)
- Currently disabled (`if: false`)
- Will be enabled when you provide Dev Portal URL
- Depends on successful service catalog deployment

### 3. Updated Files

#### `start_demo.sh`
Added section to auto-generate `terraform/terraform.tfvars`:
```bash
# Update Terraform variables with ngrok URL
cat > terraform/terraform.tfvars << EOF
fhir_server_url = "${NGROK_URL}/fhir"
EOF
```

#### `.gitignore`
Added Terraform exclusions:
```
terraform/.terraform/
terraform/.terraform.lock.hcl
terraform/*.tfstate
terraform/*.tfstate.backup
terraform/crash.log
terraform/crash.*.log
```

Note: `terraform.tfvars` is **committed** (auto-generated, no secrets)

#### `README.md`
- Added Kong Konnect section
- Updated file structure
- Added deployment instructions

### 4. Documentation

Created `KONNECT-SETUP.md`:
- Complete setup guide
- Step-by-step instructions
- Architecture diagram
- GitHub secrets configuration
- Troubleshooting guide
- Manual Terraform commands

## How It Works

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Local Development                                        │
│    ./start_demo.sh                                          │
│    ├─ Starts HAPI FHIR in Docker                           │
│    ├─ Creates ngrok tunnel                                 │
│    └─ Generates terraform/terraform.tfvars                 │
│       └─ fhir_server_url = "https://xxx.ngrok-free.dev/fhir" │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. Commit & Push                                            │
│    git add terraform/terraform.tfvars                       │
│    git commit -m "Update ngrok URL"                         │
│    git push origin main                                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. GitHub Actions (Workflow: konnect-deploy.yml)           │
│    ├─ Terraform Init                                       │
│    ├─ Terraform Validate                                   │
│    ├─ Terraform Plan                                       │
│    └─ Terraform Apply (uses KONNECT_PAT secret)           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. Kong Konnect (AU Region)                                │
│    ├─ Control Plane: "FHIR Patient Records Control Plane"  │
│    ├─ Service: "Patient Records API"                       │
│    └─ Service Catalog with full documentation             │
└─────────────────────────────────────────────────────────────┘
```

## Next Steps

### Required (Before First Deployment)

1. **Get Kong Konnect PAT Token**
   - Log in to https://cloud.konghq.com
   - Generate Personal Access Token
   - Copy the token (starts with `kpat_`)

2. **Configure GitHub Secret**
   - Go to GitHub repository settings
   - Add secret: `KONNECT_PAT` = your PAT token

3. **Test Locally**
   ```bash
   ./start_demo.sh
   # Verify terraform/terraform.tfvars was created
   cat terraform/terraform.tfvars
   ```

4. **Deploy**
   ```bash
   git add terraform/terraform.tfvars
   git commit -m "Initial Konnect deployment"
   git push origin main
   ```

5. **Verify**
   - Check GitHub Actions workflow
   - Log in to Kong Konnect
   - Navigate to Service Hub → Services
   - Find "Patient Records API"

### Optional (Future Enhancements)

1. **Dev Portal Integration**
   - Create Dev Portal in Kong Konnect
   - Get Dev Portal URL
   - Update workflow to enable `dev-portal-update` job
   - Add steps to upload OpenAPI spec

2. **Routes Configuration** (Separate Workflow)
   - Create `terraform/routes.tf`
   - Define API routes (paths, methods)
   - Create `.github/workflows/konnect-routes.yml`

3. **Plugins Configuration** (Separate Workflow)
   - Create `terraform/plugins.tf`
   - Configure rate limiting, authentication, etc.
   - Create `.github/workflows/konnect-plugins.yml`

## Testing the Setup

### Test Local Terraform (Optional)

```bash
cd terraform

# Initialize
terraform init

# Validate
terraform validate

# Plan (requires PAT token)
export TF_VAR_konnect_pat="kpat_your_token_here"
terraform plan

# Don't apply locally - let GitHub Actions do it
```

### Test GitHub Actions Workflow

1. Make a change to a Terraform file:
   ```bash
   echo "# Test change" >> terraform/service.tf
   git add terraform/service.tf
   git commit -m "Test Konnect deployment"
   git push origin main
   ```

2. Monitor workflow:
   - Go to Actions tab
   - Find "Kong Konnect Deployment" workflow
   - Watch the progress

3. Check deployment:
   - View workflow summary for outputs
   - Log in to Kong Konnect
   - Verify service was created/updated

## Service Catalog Information

Your service will appear in Kong Konnect with:

### Service Configuration
- **Name**: Patient Records API
- **Version**: 1.0.1
- **Tags**: FHIR, Healthcare, Patient Data, catalog, documented
- **Upstream**: Your ngrok URL

### Documentation
- **Purpose**: FHIR R4 compliant API for patient data management
- **Contact Team**: Healthcare Team
- **Contact Email**: healthcare-team@example.com
- **Architecture**: 
  - HAPI FHIR Server v8.6.0
  - H2 in-memory database
  - OAuth2 and API Key authentication
- **Dependencies**: 
  - HAPI FHIR Server
  - H2 Database
  - Ngrok tunnel
- **Support SLA**: 
  - Business hours: 9-5 AEST
  - Response time: 4hr critical, 24hr standard

### Control Plane
- **Name**: FHIR Patient Records Control Plane
- **Environment**: development
- **Team**: healthcare
- **API Type**: fhir

## Troubleshooting

### Issue: Workflow fails with authentication error

**Solution**: Verify KONNECT_PAT secret is set correctly in GitHub

### Issue: Invalid ngrok URL in Terraform

**Solution**: Run `./start_demo.sh` to regenerate terraform.tfvars

### Issue: Service not appearing in Konnect

**Solution**: Check workflow logs for Terraform errors, verify PAT permissions

### Issue: Terraform state conflicts

**Solution**: Ensure only GitHub Actions is applying changes (don't run `terraform apply` locally)

## Important Notes

- ✅ `terraform.tfvars` is **committed** to git (auto-generated, no secrets)
- ✅ PAT token stored in GitHub secrets (never in code)
- ✅ Ngrok URL updates automatically on each `start_demo.sh` run
- ✅ Terraform state managed by GitHub Actions
- ⚠️ Don't run `terraform apply` locally (conflicts with GitHub Actions)
- ⚠️ Ngrok free tier has 2-hour session limit (URL changes on restart)

## Resources

- [Kong Konnect Setup Guide](KONNECT-SETUP.md) - Detailed setup instructions
- [Terraform Files](terraform/) - Infrastructure as Code
- [GitHub Workflow](.github/workflows/konnect-deploy.yml) - Deployment automation
- [Kong Konnect Docs](https://docs.konghq.com/konnect/) - Official documentation
