name: Stage 3 - API Spec Testing

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Stage 2 - Integration"]
    types:
      - completed
  pull_request:
    paths:
      - '.insomnia/**'
      - 'terraform/stages/4-api-product/**/*.yaml'

env:
  NODE_VERSION: '20'

jobs:
  validate-spec:
    name: Validate OpenAPI Specification
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli
      
      - name: Validate OpenAPI Spec with Spectral
        run: |
          echo "Stage 3: API Spec Development & Testing"
          echo "========================================"
          echo ""
          
          if [ -f ".insomnia/fhir-api-openapi.yaml" ]; then
            echo "üìÑ Validating OpenAPI specification with Spectral..."
            spectral lint .insomnia/fhir-api-openapi.yaml --ruleset spectral:oas || true
          else
            echo "‚ö†Ô∏è  OpenAPI spec not found at .insomnia/fhir-api-openapi.yaml"
          fi
      
      - name: Validate Custom Spectral Rules
        run: |
          if [ -f ".spectral.yaml" ]; then
            echo ""
            echo "üìã Validating against custom Spectral rules..."
          echo ""
          if [ -f ".spectral.yaml" ] && [ -f ".insomnia/fhir-api-openapi.yaml" ]; then
            echo "üìã Validating against custom Spectral rules..."
            spectral lint .insomnia/fhir-api-openapi.yaml --ruleset .spectral.yaml || true
          else
            echo "‚ÑπÔ∏è  No custom Spectral rules found (.spectral.yaml) - skipping custom validation
        run: |
          echo ""
          echo "‚úÖ API Specification validation complete"
          echo ""
          echo "This stage validates:"
          echo "  - OpenAPI syntax and structure"
          echo "  - FHIR compliance (if Spectral rules configured)"
          echo "  - Business rules and governance"
          echo ""
          echo "For full demo experience, run locally:"
          echo "  cd terraform/stages/3-api-spec-testing && ./demo.sh"
