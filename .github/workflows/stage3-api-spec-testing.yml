name: Stage 3 - API Spec Testing

on:
  workflow_dispatch:
  # Automatic trigger disabled - use manual workflow_dispatch instead
  # workflow_run:
  #   workflows: ["Stage 2 - Integration"]
  #   types:
  #     - completed
  pull_request:
    paths:
      - '.insomnia/**'
      - 'terraform/stages/4-api-product/**/*.yaml'

env:
  NODE_VERSION: '20'

jobs:
  validate-spec:
    name: Validate OpenAPI Specification
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Insomnia CLI
        run: |
          INSO_VERSION="12.2.0"
          curl -L "https://github.com/Kong/insomnia/releases/download/core%40${INSO_VERSION}/inso-linux-x64-${INSO_VERSION}.tar.xz" -o inso.tar.xz
          tar -xf inso.tar.xz
          sudo mv inso /usr/local/bin/
          inso --version
      
      - name: Lint OpenAPI Spec with Inso
        run: |
          echo "Stage 3: API Spec Development & Testing"
          echo "========================================"
          echo ""
          
          if [ -f ".insomnia/fhir-api-openapi.yaml" ]; then
            echo "üìÑ Linting OpenAPI specification with Insomnia CLI..."
            inso lint spec .insomnia/fhir-api-openapi.yaml || true
          else
            echo "‚ö†Ô∏è  OpenAPI spec not found at .insomnia/fhir-api-openapi.yaml"
          fi
      
      - name: Run API Tests with Inso
        run: |
          echo ""
          echo "üß™ Running API endpoint tests..."
          if [ -d ".insomnia" ]; then
            inso run test --env .insomnia/environments.json || echo "‚ÑπÔ∏è  No test suites found or tests skipped"
          else
            echo "‚ÑπÔ∏è  No Insomnia workspace found - skipping tests"
          fi
      
      - name: Summary
        run: |
          echo ""
          echo "‚úÖ API Specification validation and testing complete"
          echo ""
          echo "This stage validates:"
          echo "  - OpenAPI syntax and structure (inso lint)"
          echo "  - API endpoint testing (inso run test)"
          echo "  - FHIR API compliance"
          echo ""
          echo "For full demo experience, run locally:"
          echo "  cd terraform/stages/3-api-spec-testing && ./demo.sh"
