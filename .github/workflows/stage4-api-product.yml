name: Stage 4 - API Product

on:
  workflow_dispatch:
    inputs:
      upstream_url:
        description: 'Upstream FHIR server URL (ngrok tunnel)'
        required: false
        type: string
        default: ''
      rate_limit_per_minute:
        description: 'Rate limit (requests per minute)'
        required: false
        type: number
        default: 5
      destroy:
        description: 'Destroy infrastructure'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      control_plane_id:
        required: false
        type: string
      service_id:
        required: false
        type: string
      upstream_url:
        required: false
        type: string
        default: ''
      rate_limit_per_minute:
        required: false
        type: number
        default: 5
      destroy:
        required: false
        type: boolean
        default: false
  # workflow_run:
  #   workflows: ["Stage 3 - API Spec Testing"]
  #   types:
  #     - completed

env:
  TF_VERSION: '1.14.3'

jobs:
  api-product:
    name: Deploy API Product
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      catalog_service_id: ${{ steps.terraform.outputs.catalog_service_id }}
      catalog_api_id: ${{ steps.terraform.outputs.catalog_api_id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: Configure Azure credentials
        run: |
          echo "ARM_ACCESS_KEY=${{ secrets.ARM_ACCESS_KEY }}" >> $GITHUB_ENV
      
      - name: Get IDs from Terraform State
        id: get_ids
        run: |
          # Get Control Plane ID from Stage 1 state
          cd terraform/stages/1-platform
          terraform init -backend-config=backend-azure.tfbackend
          CONTROL_PLANE_ID=$(terraform output -raw control_plane_id 2>/dev/null || echo "")
          
          # Get Service ID and upstream URL from Stage 2 state
          cd ../2-integration
          terraform init -backend-config=backend-azure.tfbackend
          SERVICE_ID=$(terraform output -raw service_id 2>/dev/null || echo "")
          UPSTREAM_URL=$(terraform output -raw upstream_url 2>/dev/null || echo "")
          
          if [ -z "$CONTROL_PLANE_ID" ] || [ -z "$SERVICE_ID" ]; then
            echo "❌ Failed to get IDs from Terraform state"
            echo "Control Plane ID: ${CONTROL_PLANE_ID:-not found}"
            echo "Service ID: ${SERVICE_ID:-not found}"
            exit 1
          fi
          
          # Use input if provided, otherwise use value from Terraform state
          if [ -n "${{ inputs.upstream_url }}" ]; then
            UPSTREAM_URL="${{ inputs.upstream_url }}"
          elif [ -z "$UPSTREAM_URL" ]; then
            # Fallback to hardcoded default if not in state
            UPSTREAM_URL="https://asia-bosker-renna.ngrok-free.dev"
          fi
          
          echo "control_plane_id=$CONTROL_PLANE_ID" >> $GITHUB_OUTPUT
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "ngrok_url=$UPSTREAM_URL" >> $GITHUB_OUTPUT
          
          echo "✓ Retrieved from Terraform state:"
          echo "  Control Plane ID: $CONTROL_PLANE_ID"
          echo "  Service ID: $SERVICE_ID"
          echo "  Upstream URL: $UPSTREAM_URL"
      
      - name: Update OpenAPI Spec with Kong Gateway URL
        if: ${{ !inputs.destroy }}
        run: |
          # Use the upstream URL from inputs or demo state
          UPSTREAM_URL="${{ inputs.upstream_url }}"
          
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "https://asia-bosker-renna.ngrok-free.dev" ]; then
            if [ -f ".demo-state.json" ]; then
              STATE_URL=$(jq -r '.ngrok_url // "https://asia-bosker-renna.ngrok-free.dev"' .demo-state.json)
              UPSTREAM_URL="$STATE_URL"
              echo "Using upstream URL from demo state: $UPSTREAM_URL"
            else
              UPSTREAM_URL="https://asia-bosker-renna.ngrok-free.dev"
              echo "Using default upstream URL: $UPSTREAM_URL"
            fi
          fi
          
          echo "Updating OpenAPI spec server URL to: $UPSTREAM_URL/fhir"
          
          # Update the server URL in the OpenAPI spec
          sed -i.bak "s|url: http://localhost:8080/fhir|url: $UPSTREAM_URL/fhir|g" .insomnia/fhir-api-openapi.yaml
          
          echo "✓ OpenAPI spec updated with upstream URL"
          grep -A1 "servers:" .insomnia/fhir-api-openapi.yaml | head -3
      
      - name: Download Stage 1 outputs
        if: ${{ github.event_name == 'workflow_run' && !inputs.destroy }}
        uses: actions/download-artifact@v4
        with:
          name: stage1-outputs
          path: terraform/stages/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download Stage 2 outputs
        if: ${{ github.event_name == 'workflow_run' && !inputs.destroy }}
        uses: actions/download-artifact@v4
        with:
          name: stage2-outputs
          path: terraform/stages/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy API Product
        if: ${{ !inputs.destroy }}
        id: terraform
        working-directory: terraform/stages/4-api-product
        run: |
          # Get IDs from previous step
          CONTROL_PLANE_ID="${{ steps.get_ids.outputs.control_plane_id }}"
          SERVICE_ID="${{ steps.get_ids.outputs.service_id }}"
          
          echo "Deploying with:"
          echo "  Control Plane ID: $CONTROL_PLANE_ID"
          echo "  Service ID: $SERVICE_ID"
          
          cat > terraform.tfvars <<EOF
          konnect_token         = "${{ secrets.KONNECT_TOKEN }}"
          control_plane_id      = "$CONTROL_PLANE_ID"
          service_id            = "$SERVICE_ID"
          rate_limit_per_minute = ${{ inputs.rate_limit_per_minute || 5 }}
          EOF
          
          terraform init -backend-config=backend-azure.tfbackend
          terraform plan
          terraform apply -auto-approve
          
          # Capture outputs
          CATALOG_SERVICE_ID=$(terraform output -json | jq -r '.catalog_service_id.value')
          CATALOG_API_ID=$(terraform output -json | jq -r '.catalog_api_id.value')
          
          echo "catalog_service_id=$CATALOG_SERVICE_ID" >> $GITHUB_OUTPUT
          echo "catalog_api_id=$CATALOG_API_ID" >> $GITHUB_OUTPUT
          
          # Save outputs for artifact
          terraform output -json > stage4-outputs.json
      
      - name: Upload outputs
        if: ${{ !inputs.destroy }}
        uses: actions/upload-artifact@v4
        with:
          name: stage4-outputs
          path: terraform/stages/4-api-product/stage4-outputs.json
          retention-days: 1
      
      - name: Destroy API Product
        if: ${{ inputs.destroy }}
        working-directory: terraform/stages/4-api-product
        run: |
          terraform init -backend-config=backend-azure.tfbackend
          terraform destroy -auto-approve \
            -var="konnect_token=${{ secrets.KONNECT_TOKEN }}" \
            -var="control_plane_id=${{ inputs.control_plane_id }}" \
            -var="service_id=${{ inputs.service_id }}"
