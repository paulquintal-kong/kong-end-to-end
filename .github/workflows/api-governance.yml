name: FHIR API Governance and Testing

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - dev
          - staging
  push:
    branches:
      - main
    paths:
      - '.insomnia/**'
      - '.spectral.yaml'
  pull_request:
    branches:
      - main
    paths:
      - '.insomnia/**'
      - '.spectral.yaml'

jobs:
  governance:
    name: API Governance - Lint OpenAPI Spec
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Inso CLI
        run: npm install -g @kong/insomnia-inso
      
      - name: Lint FHIR API Specification
        run: |
          echo "ðŸ” Running governance checks on FHIR API specification..."
          inso lint spec .insomnia/fhir-api-openapi.yaml
      
      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            .insomnia/
            .spectral.yaml
          retention-days: 30

  test:
    name: API Testing - Run Test Collection
    runs-on: ubuntu-latest
    needs: governance
    
    services:
      fhir-server:
        image: hapiproject/hapi:latest
        ports:
          - 8080:8080
        env:
          hapi.fhir.datasource.driver: org.h2.Driver
          hapi.fhir.datasource.url: jdbc:h2:mem:testdb
          hapi.fhir.datasource.username: sa
          hapi.fhir.datasource.password: ""
          hapi.fhir.fhir_version: R4
          hapi.fhir.server_address: http://localhost:8080/fhir
        options: >-
          --health-cmd "exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Inso CLI
        run: npm install -g @kong/insomnia-inso
      
      - name: Wait for FHIR server to be ready
        run: |
          echo "â³ Waiting for FHIR server to start..."
          timeout 120 bash -c 'until curl -sf http://localhost:8080/fhir/metadata > /dev/null; do sleep 2; done'
          echo "âœ… FHIR server is ready!"
      
      - name: Run API Tests
        run: |
          echo "ðŸ§ª Running FHIR API test collection..."
          inso run test "FHIR API for Patient, Observation, Encounter, Condition, and Medication (Smile CDR Compatible) 1.0.1-wrk_8482e43ebd4e4c63923f4f78a48863ce.yaml" \
            --env Base\ Environment \
            --reporter cli
        continue-on-error: true
      
      - name: Generate test report
        if: always()
        run: |
          echo "ðŸ“Š Test execution completed"
          echo "Environment: ${{ github.event.inputs.environment || 'CI' }}"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            *.xml
          retention-days: 30

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [governance, test]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# FHIR API Governance & Testing Summary ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Governance Check" >> $GITHUB_STEP_SUMMARY
          echo "- OpenAPI Spec Linting: ${{ needs.governance.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## API Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Test Collection Execution: ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
