name: Stage 5 - Developer Portal

on:
  workflow_dispatch:
    inputs:
      portal_id:
        description: 'Developer Portal ID (leave empty to auto-discover)'
        required: false
        type: string
        default: ''
      destroy:
        description: 'Destroy infrastructure'
        required: false
        type: boolean
        default: false
  # workflow_run:
  #   workflows: ["Stage 4 - API Product"]
  #   types:
  #     - completed

env:
  TF_VERSION: '1.14.3'

jobs:
  developer-portal:
    name: Deploy Developer Portal
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      portal_id: ${{ steps.terraform.outputs.portal_id }}
      portal_url: ${{ steps.terraform.outputs.portal_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: Configure Azure credentials
        run: |
          echo "ARM_ACCESS_KEY=${{ secrets.ARM_ACCESS_KEY }}" >> $GITHUB_ENV
      
      - name: Get Catalog API ID from Terraform State
        id: get_ids
        run: |
          # Get catalog_api_id from Stage 4 state
          cd terraform/stages/4-api-product
          terraform init -backend-config=backend-azure.tfbackend
          CATALOG_API_ID=$(terraform output -raw catalog_api_id 2>/dev/null || echo "")
          
          if [ -z "$CATALOG_API_ID" ]; then
            echo "âŒ Failed to get catalog_api_id from Terraform state"
            echo "Catalog API ID: ${CATALOG_API_ID:-not found}"
            exit 1
          fi
          
          echo "catalog_api_id=$CATALOG_API_ID" >> $GITHUB_OUTPUT
          
          echo "âœ“ Retrieved from Terraform state:"
          echo "  Catalog API ID: $CATALOG_API_ID"
      
      - name: Discover or Validate Portal
        id: portal_check
        run: |
          # Use input portal ID if provided, otherwise try to discover
          PORTAL_ID="${{ inputs.portal_id }}"
          
          if [ -z "$PORTAL_ID" ]; then
            echo "ðŸ” No portal ID provided, attempting to discover existing portal..."
            
            # Try to list portals using Konnect API (v3)
            PORTALS=$(curl -s -X GET "https://au.api.konghq.com/v3/portals" \
              -H "Authorization: Bearer ${{ secrets.KONNECT_TOKEN }}" \
              -H "Content-Type: application/json")
            
            # Get first portal ID if available
            PORTAL_ID=$(echo "$PORTALS" | jq -r '.data[0].id // empty')
            
            if [ -z "$PORTAL_ID" ]; then
              echo ""
              echo "âŒ No portal found in your Konnect organization"
              echo ""
              echo "Please create a Developer Portal first:"
              echo "  1. Go to https://au.cloud.konghq.com/portals"
              echo "  2. Click 'New Portal'"
              echo "  3. Configure your portal settings"
              echo "  4. Re-run this workflow with the Portal ID"
              echo ""
              echo "Or provide a Portal ID as input when running this workflow"
              exit 1
            fi
            
            echo "âœ“ Discovered portal: $PORTAL_ID"
          else
            echo "âœ“ Using provided portal ID: $PORTAL_ID"
            
            # Validate portal exists using v3 API
            PORTAL_CHECK=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X GET "https://au.api.konghq.com/v3/portals/$PORTAL_ID" \
              -H "Authorization: Bearer ${{ secrets.KONNECT_TOKEN }}" \
              -H "Content-Type: application/json")
            
            HTTP_CODE=$(echo "$PORTAL_CHECK" | grep "HTTP_CODE:" | cut -d: -f2)
            RESPONSE_BODY=$(echo "$PORTAL_CHECK" | sed '/HTTP_CODE:/d')
            
            echo "Response (HTTP $HTTP_CODE):"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
            
            if [ "$HTTP_CODE" = "200" ] && echo "$RESPONSE_BODY" | jq -e '.id' > /dev/null 2>&1; then
              echo "âœ“ Portal validated successfully"
            else
              echo "âŒ Portal ID $PORTAL_ID not found or inaccessible"
              echo "HTTP Status: $HTTP_CODE"
              if echo "$RESPONSE_BODY" | jq -e '.message' > /dev/null 2>&1; then
                echo "Error: $(echo "$RESPONSE_BODY" | jq -r '.message')"
              fi
              echo "Please check the Portal ID and try again"
              exit 1
            fi
          fi
          
          echo "portal_id=$PORTAL_ID" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“‹ Portal Details:"
          curl -s -X GET "https://au.api.konghq.com/v3/portals/$PORTAL_ID" \
            -H "Authorization: Bearer ${{ secrets.KONNECT_TOKEN }}" | jq '{id, name, default_domain}'
      
      - name: Download Stage 4 outputs
        if: ${{ github.event_name == 'workflow_run' && !inputs.destroy }}
        uses: actions/download-artifact@v4
        with:
          name: stage4-outputs
          path: terraform/stages/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish API to Developer Portal
        if: ${{ !inputs.destroy }}
        id: terraform
        working-directory: terraform/stages/5-developer-portal
        run: |
          # Get catalog API ID and portal ID from previous steps
          CATALOG_API_ID="${{ steps.get_ids.outputs.catalog_api_id }}"
          PORTAL_ID="${{ steps.portal_check.outputs.portal_id }}"
          
          cat > terraform.tfvars <<EOF
          konnect_token  = "${{ secrets.KONNECT_TOKEN }}"
          catalog_api_id = "$CATALOG_API_ID"
          portal_id      = "$PORTAL_ID"
          EOF
          
          terraform init -backend-config=backend-azure.tfbackend
          terraform plan
          terraform apply -auto-approve
          
          # Capture outputs
          PORTAL_ID=$(terraform output -raw portal_id 2>/dev/null || echo "")
          PORTAL_URL=$(terraform output -raw portal_url 2>/dev/null || echo "")
          
          echo "portal_id=$PORTAL_ID" >> $GITHUB_OUTPUT
          echo "portal_url=$PORTAL_URL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸŽ‰ API published to Developer Portal!"
          echo "Portal URL: $PORTAL_URL"
      
      - name: Unpublish API from Portal
        if: ${{ inputs.destroy }}
        working-directory: terraform/stages/5-developer-portal
        run: |
          # Get portal ID and catalog API ID for destroy
          PORTAL_ID="${{ steps.portal_check.outputs.portal_id }}"
          CATALOG_API_ID="${{ steps.get_ids.outputs.catalog_api_id }}"
          
          terraform init -backend-config=backend-azure.tfbackend
          terraform destroy -auto-approve \
            -var="konnect_token=${{ secrets.KONNECT_TOKEN }}" \
            -var="catalog_api_id=$CATALOG_API_ID" \
            -var="portal_id=$PORTAL_ID"
