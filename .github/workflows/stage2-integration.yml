name: Stage 2 - Integration

on:
  workflow_dispatch:
    inputs:
      control_plane_id:
        description: 'Control Plane ID from Stage 1'
        required: true
        type: string
      upstream_url:
        description: 'Upstream FHIR server URL'
        required: false
        type: string
        default: 'https://asia-bosker-renna.ngrok-free.dev/fhir'
      destroy:
        description: 'Destroy infrastructure'
        required: false
        type: boolean
        default: false
  # workflow_run:
  #   workflows: ["Stage 1 - Platform"]
  #   types:
  #     - completed

env:
  TF_VERSION: '1.14.3'

jobs:
  integration:
    name: Deploy Gateway Service
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      service_id: ${{ steps.terraform.outputs.service_id }}
      route_id: ${{ steps.terraform.outputs.route_id }}
      api_endpoint: ${{ steps.terraform.outputs.api_endpoint }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Load demo configuration
        id: load_config
        run: |
          if [ -f ".demo-state.json" ]; then
            echo "✓ Found demo state configuration"
            NGROK_URL=$(jq -r '.ngrok_url // "https://asia-bosker-renna.ngrok-free.dev"' .demo-state.json)
            echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
            echo "Using ngrok URL from state: $NGROK_URL"
          else
            echo "⚠ No demo state found - using default URL"
            echo "ngrok_url=https://asia-bosker-renna.ngrok-free.dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: Configure Azure credentials
        run: |
          echo "ARM_ACCESS_KEY=${{ secrets.ARM_ACCESS_KEY }}" >> $GITHUB_ENV
      
      - name: Download Stage 1 outputs
        if: ${{ github.event_name == 'workflow_run' && !inputs.destroy }}
        uses: actions/download-artifact@v4
        with:
          name: stage1-outputs
          path: terraform/stages/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy Integration
        if: ${{ !inputs.destroy }}
        id: terraform
        working-directory: terraform/stages/2-integration
        run: |
          # Get control plane ID from input or artifact
          if [ -n "${{ inputs.control_plane_id }}" ]; then
            CONTROL_PLANE_ID="${{ inputs.control_plane_id }}"
          else
            CONTROL_PLANE_ID=$(jq -r '.control_plane_id.value' ../stage1-outputs.json)
          fi
          
          # Use upstream URL from config state if available
          UPSTREAM_URL="${{ inputs.upstream_url }}"
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "https://asia-bosker-renna.ngrok-free.dev/fhir" ]; then
            if [ -f "../../../.demo-state.json" ]; then
              STATE_URL=$(jq -r '.fhir_endpoint // empty' ../../../.demo-state.json)
              if [ ! -z "$STATE_URL" ]; then
                UPSTREAM_URL="$STATE_URL"
                echo "Using upstream URL from demo state: $UPSTREAM_URL"
              fi
            fi
          fi
          
          cat > terraform.tfvars <<EOF
          konnect_token    = "${{ secrets.KONNECT_TOKEN }}"
          control_plane_id = "$CONTROL_PLANE_ID"
          upstream_url     = "$UPSTREAM_URL"
          EOF
          
          terraform init -backend-config=backend-azure.tfbackend
          terraform plan
          terraform apply -auto-approve
          
          # Capture outputs
          SERVICE_ID=$(terraform output -json | jq -r '.service_id.value')
          ROUTE_ID=$(terraform output -json | jq -r '.route_id.value')
          API_ENDPOINT=$(terraform output -json | jq -r '.api_endpoint.value')
          
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "route_id=$ROUTE_ID" >> $GITHUB_OUTPUT
          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          
          # Update demo state config
          cd ../../..
          if [ -f ".demo-state.json" ]; then
            jq --arg svc_id "$SERVICE_ID" \
               --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
               '.service_id = $svc_id | .updated_at = $updated' \
               .demo-state.json > .demo-state.json.tmp && mv .demo-state.json.tmp .demo-state.json
            echo "✓ Updated demo state with service_id"
          fi
          
          # Save outputs for artifact
          cd terraform/stages/2-integration
          terraform output -json > stage2-outputs.json
      
      - name: Upload outputs
        if: ${{ !inputs.destroy }}
        uses: actions/upload-artifact@v4
        with:
          name: stage2-outputs
          path: terraform/stages/2-integration/stage2-outputs.json
          retention-days: 1
      
      - name: Destroy Integration
        if: ${{ inputs.destroy }}
        working-directory: terraform/stages/2-integration
        run: |
          terraform init -backend-config=backend-azure.tfbackend
          terraform destroy -auto-approve \
            -var="konnect_token=${{ secrets.KONNECT_TOKEN }}" \
            -var="control_plane_id=${{ inputs.control_plane_id }}" \
            -var="upstream_url=dummy"
