services:
  # Smile CDR FHIR Server (using HAPI FHIR as open-source alternative)
  # Note: Smile CDR is a commercial product. This uses HAPI FHIR which is compatible
  fhir-server:
    image: hapiproject/hapi:latest
    container_name: smile-cdr-demo
    ports:
      - "8080:8080"
    environment:
      # Database configuration (using H2 for demo purposes)
      - hapi.fhir.datasource.driver=org.h2.Driver
      - hapi.fhir.datasource.url=jdbc:h2:mem:testdb
      - hapi.fhir.datasource.username=sa
      - hapi.fhir.datasource.password=
      # FHIR version
      - hapi.fhir.fhir_version=R4
      # Enable CORS
      - hapi.fhir.cors.allowed_origin=*
      # Server settings
      - hapi.fhir.server_address=http://localhost:8080/fhir
      - hapi.fhir.allow_external_references=true
      - hapi.fhir.allow_multiple_delete=true
      - hapi.fhir.allow_placeholder_references=true
      - hapi.fhir.reuse_cached_search_results_millis=60000
      # Enable narrative generation
      - hapi.fhir.narrative_enabled=true
      # Enable validation
      - hapi.fhir.validation_enabled=true
    volumes:
      - fhir-data:/data/hapi
    restart: unless-stopped
    networks:
      - fhir-network

  # Kong Gateway Data Plane (connected to Konnect Control Plane)
  kong-gateway:
    image: kong/kong-gateway:3.13.0.0
    container_name: kong-dataplane
    environment:
      # Data Plane mode
      - KONG_ROLE=data_plane
      - KONG_DATABASE=off
      
      # Konnect Control Plane connection
      - KONG_CLUSTER_CONTROL_PLANE=c1ed874bc8.au.cp0.konghq.com:443
      - KONG_CLUSTER_SERVER_NAME=c1ed874bc8.au.cp0.konghq.com
      - KONG_CLUSTER_TELEMETRY_ENDPOINT=c1ed874bc8.au.tp0.konghq.com:443
      - KONG_CLUSTER_TELEMETRY_SERVER_NAME=c1ed874bc8.au.tp0.konghq.com
      
      # Use pinned certificates (mTLS)
      - KONG_CLUSTER_MTLS=pki
      - KONG_CLUSTER_CERT=/etc/secrets/kong-cluster/tls.crt
      - KONG_CLUSTER_CERT_KEY=/etc/secrets/kong-cluster/tls.key
      
      # Proxy configuration
      - KONG_PROXY_LISTEN=0.0.0.0:8000
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      
      # Additional settings
      - KONG_LUA_SSL_TRUSTED_CERTIFICATE=system
      - KONG_VITALS=off
    ports:
      - "8000:8000"  # Proxy port (HTTP)
      - "8443:8443"  # Proxy port (HTTPS)
    volumes:
      - ./.kong:/etc/secrets/kong-cluster:ro
    restart: unless-stopped
    networks:
      - fhir-network
    depends_on:
      - fhir-server

volumes:
  fhir-data:
    driver: local

networks:
  fhir-network:
    driver: bridge
